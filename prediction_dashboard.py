# import dash
# from dash import dcc, html
# import plotly.graph_objects as go
# import pandas as pd

# # --- Load Data ---
# # Load the predictions generated by PySpark
# try:
#     df_predictions = pd.read_csv("energy_predictions.csv")
#     # Load original data to get metrics
#     df_metrics = pd.read_csv("renewable_energy.csv")
#     df_metrics = df_metrics.dropna() # Drop NA for simple stats
# except FileNotFoundError:
#     print("Error: CSV files not found.")
#     print("Please run 'generate_energy_data.py' and 'energy_prediction.py' first.")
#     exit()

# # --- Prepare Data for Visualization ---

# # 1. KPIs (Key Performance Indicators)
# avg_power_actual = df_metrics['power_output'].mean()
# avg_power_predicted = df_predictions['prediction'].mean()
# avg_temp = df_metrics['temperature'].mean()
# avg_wind = df_metrics['wind_speed'].mean()


# # 2. Create Traces for Plot
# trace_actual = go.Scatter(
#     x=df_predictions['day'],
#     y=df_predictions['power_output'],
#     mode='lines',
#     name='Actual Power Output',
#     line=dict(color='blue', width=2)
# )

# trace_predicted = go.Scatter(
#     x=df_predictions['day'],
#     y=df_predictions['prediction'],
#     mode='lines',
#     name='Predicted Power Output',
#     line=dict(color='red', dash='dot', width=2)
# )

# # 3. Create the Figure
# fig_trends = go.Figure(
#     data=[trace_actual, trace_predicted],
#     layout=go.Layout(
#         title='Actual vs. Predicted Power Generation Trends',
#         xaxis_title='Day',
#         yaxis_title='Power Output (MW)',
#         hovermode='x unified',
#         legend=dict(x=0.01, y=0.99),
#         margin=dict(l=40, r=40, t=40, b=40)
#     )
# )

# # --- Initialize Dash App ---
# app = dash.Dash(__name__, external_stylesheets=['https://codepen.io/chriddyp/pen/bWLwgP.css'])
# app.title = "Energy Prediction Dashboard"

# # --- App Layout ---
# app.layout = html.Div(style={'fontFamily': 'Arial, sans-serif'}, children=[
#     html.H1(children='Renewable Energy Output Prediction Dashboard', style={'textAlign': 'center', 'color': '#333'}),

#     # --- KPIs ---
#     html.Div(className='row', style={'margin': '20px'}, children=[
#         html.Div(className='three columns', style={'textAlign': 'center', 'padding': '10px', 'border': '1px solid #ddd', 'borderRadius': '5px', 'margin': '5px', 'backgroundColor': '#f9f9f9'}, children=[
#             html.H4('Avg. Actual Power'),
#             html.H3(f"{avg_power_actual:.2f} MW")
#         ]),
#         html.Div(className='three columns', style={'textAlign': 'center', 'padding': '10px', 'border': '1px solid #ddd', 'borderRadius': '5px', 'margin': '5px', 'backgroundColor': '#f9f9f9'}, children=[
#             html.H4('Avg. Predicted Power'),
#             html.H3(f"{avg_power_predicted:.2f} MW")
#         ]),
#         html.Div(className='three columns', style={'textAlign': 'center', 'padding': '10px', 'border': '1px solid #ddd', 'borderRadius': '5px', 'margin': '5px', 'backgroundColor': '#f9f9f9'}, children=[
#             html.H4('Avg. Temperature'),
#             html.H3(f"{avg_temp:.2f} °C")
#         ]),
#         html.Div(className='three columns', style={'textAlign': 'center', 'padding': '10px', 'border': '1px solid #ddd', 'borderRadius': '5px', 'margin': '5px', 'backgroundColor': '#f9f9f9'}, children=[
#             html.H4('Avg. Wind Speed'),
#             html.H3(f"{avg_wind:.2f} km/h")
#         ]),
#     ]),
    
#     # --- Trend Graph ---
#     html.Div(className='row', style={'margin': '20px'}, children=[
#         html.H2('Task 6: Actual vs. Predicted Visualization', style={'textAlign': 'center'}),
#         dcc.Graph(
#             id='trends-graph',
#             figure=fig_trends,
#             style={'height': '500px'}
#         )
#     ]),

#     # --- Model Performance (from console output) ---
#     html.Div(className='row', style={'margin': '20px'}, children=[
#         html.H2('Task 5: Model Performance (from PySpark run)', style={'textAlign': 'center'}),
#         html.P(
#             "Check your console output from 'energy_prediction.py' for RMSE and MAE values.",
#             style={'textAlign': 'center', 'fontSize': '18px'}
#         )
#     ])
# ])

# # --- Run the App ---
# if __name__ == '__main__':
#     app.run(debug=True)





import dash
from dash import dcc, html
import plotly.graph_objects as go
import pandas as pd
import json
import dash_bootstrap_components as dbc  # Import new library

# --- Load Data ---
try:
    df_predictions = pd.read_csv("energy_predictions.csv")
    df_metrics = pd.read_csv("renewable_energy.csv").dropna()
    # Load the new metrics file
    with open("model_metrics.json", 'r') as f:
        metrics = json.load(f)
except Exception as e:
    print(f"Error loading data: {e}")
    print("Please run 'generate_energy_data.py' and 'energy_prediction.py' first.")
    exit()

# --- Prepare Data for Visualization ---

# 1. KPIs
kpi_data = {
    "Avg. Actual Power": f"{df_metrics['power_output'].mean():.2f} MW",
    "Avg. Predicted Power": f"{df_predictions['prediction'].mean():.2f} MW",
    "Model RMSE": f"{metrics['rmse']:.2f}",
    "Model MAE": f"{metrics['mae']:.2f}",
    "Avg. Temperature": f"{df_metrics['temperature'].mean():.2f} °C",
    "Avg. Wind Speed": f"{df_metrics['wind_speed'].mean():.2f} km/h"
}

# Helper function to create styled KPI cards
def create_kpi_card(title, value):
    return dbc.Card(
        dbc.CardBody([
            html.H4(title, className="card-title", style={'textAlign': 'center', 'fontSize': '1rem'}),
            html.H3(value, className="card-text", style={'textAlign': 'center', 'fontSize': '1.5rem'})
        ]),
        className="m-2", # Margin
        color="secondary", # Card color
        inverse=True # White text
    )

kpi_cards = [dbc.Col(create_kpi_card(title, value), width=6, lg=2) for title, value in kpi_data.items()]

# 2. Create Traces for Plot
trace_actual = go.Scatter(
    x=df_predictions['day'],
    y=df_predictions['power_output'],
    mode='lines',
    name='Actual Power',
    line=dict(color='#4B8BBE', width=2) # Blue
)

trace_predicted = go.Scatter(
    x=df_predictions['day'],
    y=df_predictions['prediction'],
    mode='lines',
    name='Predicted Power',
    line=dict(color='#E74C3C', dash='dot', width=2) # Red
)

# 3. Create the Figure
fig_trends = go.Figure(
    data=[trace_actual, trace_predicted],
    layout=go.Layout(
        # We put the title in the layout now, not with H2
        title='Task 6: Actual vs. Predicted Power Generation Trends',
        title_x=0.5, # Center the title
        xaxis_title='Day',
        yaxis_title='Power Output (MW)',
        hovermode='x unified',
        legend=dict(x=0.01, y=0.99, orientation='h'),
        margin=dict(l=40, r=40, t=40, b=40),
        template='plotly_dark'  # Use dark template for the graph
    )
)

# --- Initialize Dash App ---
app = dash.Dash(__name__, external_stylesheets=[dbc.themes.CYBORG]) # Use CYBORG dark theme
app.title = "Energy Prediction Dashboard"

# --- App Layout ---
app.layout = dbc.Container(fluid=True, style={'backgroundColor': '#2a3f5f'}, children=[ # Dark background
    # Title
    dbc.Row(
        dbc.Col(html.H1(
            children='Renewable Energy Output Prediction Dashboard', 
            style={'textAlign': 'center', 'color': 'white', 'padding': '20px'}
        ))
    ),
    
    # --- KPIs ---
    # This is "Task 5" - we put it at the top now!
    dbc.Row(kpi_cards, justify="center", className="mb-4", 
            style={'padding': '10px', 'border': '1px solid #444', 'borderRadius': '5px', 'backgroundColor': '#1a2b4f'}),
    
    # --- Trend Graph ---
    dbc.Row(
        dbc.Col(
            dbc.Card(
                dbc.CardBody(dcc.Graph(
                    id='trends-graph',
                    figure=fig_trends,
                    style={'height': '60vh'}
                )),
                color="dark"
            ),
            width=12
        ),
        className="mb-4"
    ),
])

# --- Run the App ---
if __name__ == '__main__':
    app.run(debug=True) 